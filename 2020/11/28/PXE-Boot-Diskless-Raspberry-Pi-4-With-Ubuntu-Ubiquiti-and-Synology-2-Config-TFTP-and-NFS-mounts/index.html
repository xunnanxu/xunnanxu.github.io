
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Shawn&#39;s Pitstop">
    <title>PXE Boot Diskless Raspberry Pi 4 With Ubuntu, Ubiquiti and Synology (2): Config TFTP and NFS mounts - Shawn&#39;s Pitstop</title>
    <meta name="author" content="Shawn Xu">
    
    
    
        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss2.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Shawn Xu","sameAs":["https://github.com/xunnanxu"],"image":"https://miro.medium.com/fit/c/90/90/1*7cPXDgvy2_tKMHR4SEd-yQ.jpeg"},"articleBody":"Once we get the DHCP part set up, here comes the exciting part - to actually install the Linux distro and boot the Pi using it instead of the vanilla 32-bit Raspberry Pi OS.\nNow our Pi is still stuck at the initial screen, but don’t worry, as long as it is trying to read the tftp path we have made progress.\nEnable TFTP on the Server SideHere I will be using the Synology NAS server as the file system server.\nSynology offers tftp support in file sharing directly. On the other hand, it’s also fairly straightforward to set up a TFTP server using a Linux server. One thing important is to remember the tftp root directory. That will be used in the next step to copy over the boot files to.\nUnder that directory create the Pi corresponding directory like\n1&lt;tftp root&gt;/123456789\n\n123456789 refers to last 9 chars of serial no. Pi’s bootloader by default will load from there.\nCreate the TFTP boot directoryWe need to first grab the Linux distro from an image.\nHere I picked Ubuntu 20.04 LTS which is “officially” supported. Technically this is probably not the best option as the OS itself includes a lot of things that we may not actually need and the size is pretty bulky. On the other end the Alpine one is very skinny and lacks some of the tooling we may need initially. For raspberry, unfortunately each distro may be slightly different (in terms of boot) so while you are free to choose whatever you want, YMMV.\nFlash the image into the SD card and we’ll get 2 partitions - boot and root.\nIn general, it’s a good idea to first boot the system using the SD card just in case there’s some essential setup we need to complete ahead of time. After that, the remaining Pi boards can replicate the same set of files with minor tweaks.\n\n\nAfter that use rsync to copy the boot files:\n1sudo rsync -xa /boot 192.168.1.60:&lt;tftp root&gt;/123456789/\n\nHere we need to perform some cleanup.\nPi will need a few critical files during the boot process.\nstart4.elf, bcm2711-rpi-4-b.dtb, dtb these are the firmware filesconfig.txt, usercfg.txt, syscfg.txt these are the config files to locate the kernel files and related configsvmlinuz, System.map, initrd.img Linux kernel filescmdline.txt contains config params to pass to the kernel\nThe overall boot directory structure would eventually look roughly like this:\n1234567891011121314151617181920-rwxr--r--   1 root  root     46612 Sep  7 22:20 bcm2711-rpi-4-b.dtb-rwxr--r--   1 root  root       184 Sep 13 14:56 cmdline.txt-rw-r--r--   1 root  root    218826 Oct 15 06:16 config-5.4.0-1022-raspi-rwxr--r--   1 root  root      1189 Nov 27 13:50 config.txtlrwxr--r--   1 root  root        43 Oct 21 23:47 dtb -&gt; dtbs/5.4.0-1022-raspi/./bcm2711-rpi-4-b.dtblrwxr--r--   1 root  root        43 Oct 21 23:47 dtb-5.4.0-1022-raspi -&gt; dtbs/5.4.0-1022-raspi/./bcm2711-rpi-4-b.dtbdrwxr--r--   8 root  root      4096 Oct 21 23:45 dtbsdrwxr--r--   8 root  root      4096 Sep 13 15:13 firmware-rwxr--r--   1 root  root      5405 Sep  7 22:20 fixup4.datlrwxr--r--   1 root  root        27 Oct 21 23:46 initrd.img -&gt; initrd.img-5.4.0-1022-raspi-rw-r--r--   1 root  root  29325769 Oct 21 23:47 initrd.img-5.4.0-1022-raspilrwxr--r--   1 root  root        27 Oct 21 23:46 initrd.img.old -&gt; initrd.img-5.4.0-1021-raspi-rwxr--r--   1 root  root   2272992 Sep  7 22:21 start4.elf-rwxr--r--   1 root  root       327 Sep  7 22:21 syscfg.txt-rw-------   1 root  root   4164641 Oct 15 06:16 System.map-5.4.0-1022-raspi-rwxr--r--   1 root  root       200 Sep  7 22:21 usercfg.txtlrwxr--r--   1 root  root        24 Oct 21 23:46 vmlinuz -&gt; vmlinuz-5.4.0-1022-raspi-rwx------   1 root  root   8306127 Oct  5 02:16 vmlinuz-5.4.0-1022-raspi-rwx------   1 root  root  25907712 Oct 15 10:16 vmlinux-5.4.0-1022-raspilrwxr--r--   1 root  root        24 Oct 21 23:46 vmlinuz.old -&gt; vmlinuz-5.4.0-1021-raspi\n\nWe need to make a few modifications here.\nUncompress the Linux kernel vmlinuzPitfall #2: Pi does not uncompress the vmlinuz kernel file\nThe typical linux kernel vmlinuz is a gzipped executable that’s initially loaded into the memory. However Pi’s bootloader somehow does not uncompress it and as a result upon boot it would be stuck in rainbow screen.\nBefore uncompressing, be aware that some Linux distro may have a non-0 offset of the actual executable. We can check via od. A gzip file has the header 1f 8b 08 00.\n123sudo od -A d -t x1 vmlinuz-5.4.0-1022-raspi | grep &apos;1f 8b 08 00&apos;0000000 1f 8b 08 00 00 00 00 00 02 03 ec 5c 0d 74 14 55\n\nHere the offset is 0000000 and hence we can just do\n1zcat vmlinuz-5.4.0-1022-raspi &gt; vmlinux-5.4.0-1022-raspi\n\nSpecify the kernel file location in configPitfall #3: The default Uboot config does not work\nI didn’t verify other distros but at least with the ubuntu image, the default config is to use uboot. However with netboot config, it would be stuck locating the kernel and other stuff. So here we will tell Pi to boot directly with the vmlinux file we just uncompressed.\nSo here we will comment out the original entries and just specify the kernel directly in all section:\n123456789101112131415[pi4]                            # kernel=uboot_rpi_4.binmax_framebuffers=2                                 [pi2]                            # kernel=uboot_rpi_2.bin                                 [pi3]                            # kernel=uboot_rpi_3.bin                                 [all]                            arm_64bit=1                      device_tree_address=0x03000000kernel=vmlinux-5.4.0-1022-raspi  initramfs initrd.img-5.4.0-1022-raspi followkernel\n\nHere we are sort of breaking the best practice by specifying the fixed version here so we are not getting updated kernel. We are doing this because the kernel needs to be uncompressed and initrd needs to match the version. Technically the kernel update process can include the uncompression as well but that would be a TODO item.\nUpdate cmdline.txtHere we need to tell the kernel how to mount the root fs.\nSince we are going to set up the diskless boot we will mount via nfs.\nThe cmdline.txt would roughly be like:\n1net.ifnames=0 dwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=/dev/nfs nfsroot=192.168.1.60:&lt;nfs root&gt;/raspberry/123456789 ip=dhcp elevator=deadline rootwait fixrtc rw\n\nHere the nfs root is the directory in the NAS. 192.168.1.60 is the NAS IP. 123456789 again is the Pi serial but it technically could be anything unique. We are setting it like that for consistency.\nSo far we have finished configuring the tftp side.\nCreate NFS root fsCopy over FilesSimilar to boot directory we will rsync the root fs:\n1sudo rsync -xa / 192.168.1.60:&lt;nfs root&gt;/raspberry/123456789\n\nHere -x is important to ensure we don’t copy anything mounted.Particularly the boot directory would be left out and we can either make a soft link back to the one under tftp, or mount it in /etc/fstab explicitly.\nUpdate /etc/fstabUpdate the one we just copied over to NAS nfs directory as that would be read upon next boot.\n1234192.168.1.60:&lt;nfs root&gt;/raspberry/123456789   /       nfs     defaults,rw,nolock   0  0tmpfs   /tmp    tmpfs   defaults    0   0tmpfs   /var/tmp    tmpfs   defaults    0   0tmpfs   /var/run    tmpfs   defaults    0   0\n\nHere we’ll mount some of the tmp dirs to tmpfs (mem fs).\nThe root fs is technically not required as in cmdline.txt the kernel already mounts it as rw but here we are explicitly marking it so and turning off disk check.\nEnable NFS ServerFor Synology this part is easy, in file sharing there’s an option to turn on NFS in File Services.\nRemember to turn off NFS squash in shared file\n\n\nTesting and TroubleshootingSo far we have completed the necessary steps. It’s time to unplug the Pi, remove the microSD card and reboot.\nThe Pi should tell us it fails reading the card and will try PXE boot next.\nOn the first screen it should show what files it’s trying to read and if it’s stuck on some of them check the tftp logs to see if they are placed properly.\nNext it will show the rainbow screen like this\n\n\nIf you see this, that means Pi’s GPU has been properly initialized and next it would try to load the kernel.\nIf the screen is stuck in this step, go back to check if the kernel file is properly uncompressed and referred to in config.txt file.\nThis screen should last for a few seconds to tens of seconds depending on network speed. After that the Linux kernel executable should take it over to init other stuff and mount the NFS root.\ninitramfs would be loaded at this moment and if the version does not match you might get some random weird errors. If NFS is not mounted correctly, it would tell so.\nWith Ubuntu depending on your actual env, there may be a few other extra non critical errors we need to fix like cloud-init but typically they would not block the startup process.\nNow we should be able to ssh into the system with the username ubuntu.\nCongrats we have finished the netboot setup and this can be replicated to other Pis with the same process.\n","dateCreated":"2020-11-28T21:37:17-08:00","dateModified":"2020-11-29T12:23:56-08:00","datePublished":"2020-11-28T21:37:17-08:00","description":"Once we get the DHCP part set up, here comes the exciting part - to actually install the Linux distro and boot the Pi using it instead of the vanilla 32-bit Raspberry Pi OS.\nNow our Pi is still stuck at the initial screen, but don’t worry, as long as it is trying to read the tftp path we have made progress.\nEnable TFTP on the Server SideHere I will be using the Synology NAS server as the file system server.\nSynology offers tftp support in file sharing directly. On the other hand, it’s also fairly straightforward to set up a TFTP server using a Linux server. One thing important is to remember the tftp root directory. That will be used in the next step to copy over the boot files to.\nUnder that directory create the Pi corresponding directory like\n1&lt;tftp root&gt;/123456789\n\n123456789 refers to last 9 chars of serial no. Pi’s bootloader by default will load from there.\nCreate the TFTP boot directoryWe need to first grab the Linux distro from an image.\nHere I picked Ubuntu 20.04 LTS which is “officially” supported. Technically this is probably not the best option as the OS itself includes a lot of things that we may not actually need and the size is pretty bulky. On the other end the Alpine one is very skinny and lacks some of the tooling we may need initially. For raspberry, unfortunately each distro may be slightly different (in terms of boot) so while you are free to choose whatever you want, YMMV.\nFlash the image into the SD card and we’ll get 2 partitions - boot and root.\nIn general, it’s a good idea to first boot the system using the SD card just in case there’s some essential setup we need to complete ahead of time. After that, the remaining Pi boards can replicate the same set of files with minor tweaks.","headline":"PXE Boot Diskless Raspberry Pi 4 With Ubuntu, Ubiquiti and Synology (2): Config TFTP and NFS mounts","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/"},"publisher":{"@type":"Organization","name":"Shawn Xu","sameAs":["https://github.com/xunnanxu"],"image":"https://miro.medium.com/fit/c/90/90/1*7cPXDgvy2_tKMHR4SEd-yQ.jpeg","logo":{"@type":"ImageObject","url":"https://miro.medium.com/fit/c/90/90/1*7cPXDgvy2_tKMHR4SEd-yQ.jpeg"}},"url":"https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/","keywords":"linux, raspberry, network"}</script>
    <meta name="description" content="Once we get the DHCP part set up, here comes the exciting part - to actually install the Linux distro and boot the Pi using it instead of the vanilla 32-bit Raspberry Pi OS. Now our Pi is still stuck">
<meta name="keywords" content="linux,raspberry,network">
<meta property="og:type" content="blog">
<meta property="og:title" content="PXE Boot Diskless Raspberry Pi 4 With Ubuntu, Ubiquiti and Synology (2): Config TFTP and NFS mounts">
<meta property="og:url" content="https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/index.html">
<meta property="og:site_name" content="Shawn&#39;s Pitstop">
<meta property="og:description" content="Once we get the DHCP part set up, here comes the exciting part - to actually install the Linux distro and boot the Pi using it instead of the vanilla 32-bit Raspberry Pi OS. Now our Pi is still stuck">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/nfs-permission.png">
<meta property="og:image" content="https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/rainbow.jpg">
<meta property="og:updated_time" content="2020-11-29T20:23:56.132Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PXE Boot Diskless Raspberry Pi 4 With Ubuntu, Ubiquiti and Synology (2): Config TFTP and NFS mounts">
<meta name="twitter:description" content="Once we get the DHCP part set up, here comes the exciting part - to actually install the Linux distro and boot the Pi using it instead of the vanilla 32-bit Raspberry Pi OS. Now our Pi is still stuck">
<meta name="twitter:image" content="https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/nfs-permission.png">
    
    
        
    
    
        <meta property="og:image" content="https://miro.medium.com/fit/c/90/90/1*7cPXDgvy2_tKMHR4SEd-yQ.jpeg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-yvywglw62lgxwz25dsjvepo05oagkygdd7st7xfdzhmmxwqoijtiy3ngabtp.min.css">
    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-83953865-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-83953865-1');
    </script>


    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/ "
            aria-label=""
        >
            Shawn&#39;s Pitstop
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="https://miro.medium.com/fit/c/90/90/1*7cPXDgvy2_tKMHR4SEd-yQ.jpeg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="https://miro.medium.com/fit/c/90/90/1*7cPXDgvy2_tKMHR4SEd-yQ.jpeg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Shawn Xu</h4>
                
                    <h5 class="sidebar-profile-bio"><p>Software Engineer in Bay Area</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/xunnanxu"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            PXE Boot Diskless Raspberry Pi 4 With Ubuntu, Ubiquiti and Synology (2): Config TFTP and NFS mounts
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-11-28T21:37:17-08:00">
	
		    Nov 28, 2020
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>Once we get the DHCP part set up, here comes the exciting part - to actually install the Linux distro and boot the Pi using it instead of the vanilla 32-bit Raspberry Pi OS.</p>
<p>Now our Pi is still stuck at the initial screen, but don’t worry, as long as it is trying to read the tftp path we have made progress.</p>
<h2 id="Enable-TFTP-on-the-Server-Side"><a href="#Enable-TFTP-on-the-Server-Side" class="headerlink" title="Enable TFTP on the Server Side"></a>Enable TFTP on the Server Side</h2><p>Here I will be using the Synology NAS server as the file system server.</p>
<p>Synology offers tftp support in file sharing directly. On the other hand, it’s also fairly straightforward to set up a TFTP server using a Linux server. One thing important is to remember the tftp root directory. That will be used in the next step to copy over the boot files to.</p>
<p>Under that directory create the Pi corresponding directory like</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;tftp root&gt;/123456789</span><br></pre></td></tr></table></figure>

<p><code>123456789</code> refers to last 9 chars of serial no. Pi’s bootloader by default will load from there.</p>
<h2 id="Create-the-TFTP-boot-directory"><a href="#Create-the-TFTP-boot-directory" class="headerlink" title="Create the TFTP boot directory"></a>Create the TFTP boot directory</h2><p>We need to first grab the Linux distro from an image.</p>
<p>Here I picked Ubuntu 20.04 LTS which is “officially” supported. Technically this is probably not the best option as the OS itself includes a lot of things that we may not actually need and the size is pretty bulky. On the other end the Alpine one is very skinny and lacks some of the tooling we may need initially. For raspberry, unfortunately each distro may be slightly different (in terms of boot) so while you are free to choose whatever you want, YMMV.</p>
<p>Flash the image into the SD card and we’ll get 2 partitions - boot and root.</p>
<p>In general, it’s a good idea to first boot the system using the SD card just in case there’s some essential setup we need to complete ahead of time. After that, the remaining Pi boards can replicate the same set of files with minor tweaks.</p>
<a id="more"></a>

<p>After that use <code>rsync</code> to copy the boot files:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rsync -xa /boot 192.168.1.60:&lt;tftp root&gt;/123456789/</span><br></pre></td></tr></table></figure>

<p>Here we need to perform some cleanup.</p>
<p>Pi will need a few critical files during the boot process.</p>
<p><code>start4.elf</code>, <code>bcm2711-rpi-4-b.dtb</code>, <code>dtb</code> these are the firmware files<br><code>config.txt</code>, <code>usercfg.txt</code>, <code>syscfg.txt</code> these are the config files to locate the kernel files and related configs<br><code>vmlinuz</code>, <code>System.map</code>, <code>initrd.img</code> Linux kernel files<br><code>cmdline.txt</code> contains config params to pass to the kernel</p>
<p>The overall <code>boot</code> directory structure would eventually look roughly like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">-rwxr--r--   1 root  root     46612 Sep  7 22:20 bcm2711-rpi-4-b.dtb</span><br><span class="line">-rwxr--r--   1 root  root       184 Sep 13 14:56 cmdline.txt</span><br><span class="line">-rw-r--r--   1 root  root    218826 Oct 15 06:16 config-5.4.0-1022-raspi</span><br><span class="line">-rwxr--r--   1 root  root      1189 Nov 27 13:50 config.txt</span><br><span class="line">lrwxr--r--   1 root  root        43 Oct 21 23:47 dtb -&gt; dtbs/5.4.0-1022-raspi/./bcm2711-rpi-4-b.dtb</span><br><span class="line">lrwxr--r--   1 root  root        43 Oct 21 23:47 dtb-5.4.0-1022-raspi -&gt; dtbs/5.4.0-1022-raspi/./bcm2711-rpi-4-b.dtb</span><br><span class="line">drwxr--r--   8 root  root      4096 Oct 21 23:45 dtbs</span><br><span class="line">drwxr--r--   8 root  root      4096 Sep 13 15:13 firmware</span><br><span class="line">-rwxr--r--   1 root  root      5405 Sep  7 22:20 fixup4.dat</span><br><span class="line">lrwxr--r--   1 root  root        27 Oct 21 23:46 initrd.img -&gt; initrd.img-5.4.0-1022-raspi</span><br><span class="line">-rw-r--r--   1 root  root  29325769 Oct 21 23:47 initrd.img-5.4.0-1022-raspi</span><br><span class="line">lrwxr--r--   1 root  root        27 Oct 21 23:46 initrd.img.old -&gt; initrd.img-5.4.0-1021-raspi</span><br><span class="line">-rwxr--r--   1 root  root   2272992 Sep  7 22:21 start4.elf</span><br><span class="line">-rwxr--r--   1 root  root       327 Sep  7 22:21 syscfg.txt</span><br><span class="line">-rw-------   1 root  root   4164641 Oct 15 06:16 System.map-5.4.0-1022-raspi</span><br><span class="line">-rwxr--r--   1 root  root       200 Sep  7 22:21 usercfg.txt</span><br><span class="line">lrwxr--r--   1 root  root        24 Oct 21 23:46 vmlinuz -&gt; vmlinuz-5.4.0-1022-raspi</span><br><span class="line">-rwx------   1 root  root   8306127 Oct  5 02:16 vmlinuz-5.4.0-1022-raspi</span><br><span class="line">-rwx------   1 root  root  25907712 Oct 15 10:16 vmlinux-5.4.0-1022-raspi</span><br><span class="line">lrwxr--r--   1 root  root        24 Oct 21 23:46 vmlinuz.old -&gt; vmlinuz-5.4.0-1021-raspi</span><br></pre></td></tr></table></figure>

<p>We need to make a few modifications here.</p>
<h3 id="Uncompress-the-Linux-kernel-vmlinuz"><a href="#Uncompress-the-Linux-kernel-vmlinuz" class="headerlink" title="Uncompress the Linux kernel vmlinuz"></a>Uncompress the Linux kernel vmlinuz</h3><p><strong>Pitfall #2: Pi does not uncompress the vmlinuz kernel file</strong></p>
<p>The typical linux kernel vmlinuz is a gzipped executable that’s initially loaded into the memory. However Pi’s bootloader somehow does not uncompress it and as a result upon boot it would be stuck in rainbow screen.</p>
<p>Before uncompressing, be aware that some Linux distro may have a non-0 offset of the actual executable. We can check via <code>od</code>. A gzip file has the header <code>1f 8b 08 00</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo od -A d -t x1 vmlinuz-5.4.0-1022-raspi | grep &apos;1f 8b 08 00&apos;</span><br><span class="line"></span><br><span class="line">0000000 1f 8b 08 00 00 00 00 00 02 03 ec 5c 0d 74 14 55</span><br></pre></td></tr></table></figure>

<p>Here the offset is <code>0000000</code> and hence we can just do</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zcat vmlinuz-5.4.0-1022-raspi &gt; vmlinux-5.4.0-1022-raspi</span><br></pre></td></tr></table></figure>

<h3 id="Specify-the-kernel-file-location-in-config"><a href="#Specify-the-kernel-file-location-in-config" class="headerlink" title="Specify the kernel file location in config"></a>Specify the kernel file location in config</h3><p><strong>Pitfall #3: The default Uboot config does not work</strong></p>
<p>I didn’t verify other distros but at least with the ubuntu image, the default config is to use uboot. However with netboot config, it would be stuck locating the kernel and other stuff. So here we will tell Pi to boot directly with the vmlinux file we just uncompressed.</p>
<p>So here we will comment out the original entries and just specify the kernel directly in <code>all</code> section:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[pi4]                            </span><br><span class="line"># kernel=uboot_rpi_4.bin</span><br><span class="line">max_framebuffers=2</span><br><span class="line">                                 </span><br><span class="line">[pi2]                            </span><br><span class="line"># kernel=uboot_rpi_2.bin</span><br><span class="line">                                 </span><br><span class="line">[pi3]                            </span><br><span class="line"># kernel=uboot_rpi_3.bin</span><br><span class="line">                                 </span><br><span class="line">[all]                            </span><br><span class="line">arm_64bit=1                      </span><br><span class="line">device_tree_address=0x03000000</span><br><span class="line">kernel=vmlinux-5.4.0-1022-raspi  </span><br><span class="line">initramfs initrd.img-5.4.0-1022-raspi followkernel</span><br></pre></td></tr></table></figure>

<p>Here we are sort of breaking the best practice by specifying the fixed version here so we are not getting updated kernel. We are doing this because the kernel needs to be uncompressed and <code>initrd</code> needs to match the version. Technically the kernel update process can include the uncompression as well but that would be a TODO item.</p>
<h3 id="Update-cmdline-txt"><a href="#Update-cmdline-txt" class="headerlink" title="Update cmdline.txt"></a>Update cmdline.txt</h3><p>Here we need to tell the kernel how to mount the root fs.</p>
<p>Since we are going to set up the diskless boot we will mount via nfs.</p>
<p>The cmdline.txt would roughly be like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ifnames=0 dwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=/dev/nfs nfsroot=192.168.1.60:&lt;nfs root&gt;/raspberry/123456789 ip=dhcp elevator=deadline rootwait fixrtc rw</span><br></pre></td></tr></table></figure>

<p>Here the nfs root is the directory in the NAS. <code>192.168.1.60</code> is the NAS IP. <code>123456789</code> again is the Pi serial but it technically could be anything unique. We are setting it like that for consistency.</p>
<p>So far we have finished configuring the tftp side.</p>
<h2 id="Create-NFS-root-fs"><a href="#Create-NFS-root-fs" class="headerlink" title="Create NFS root fs"></a>Create NFS root fs</h2><h3 id="Copy-over-Files"><a href="#Copy-over-Files" class="headerlink" title="Copy over Files"></a>Copy over Files</h3><p>Similar to boot directory we will rsync the root fs:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rsync -xa / 192.168.1.60:&lt;nfs root&gt;/raspberry/123456789</span><br></pre></td></tr></table></figure>

<p>Here <code>-x</code> is important to ensure we don’t copy anything mounted.<br>Particularly the <code>boot</code> directory would be left out and we can either make a soft link back to the one under tftp, or mount it in <code>/etc/fstab</code> explicitly.</p>
<h3 id="Update-etc-fstab"><a href="#Update-etc-fstab" class="headerlink" title="Update /etc/fstab"></a>Update /etc/fstab</h3><p>Update the one we just copied over to NAS nfs directory as that would be read upon next boot.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.60:&lt;nfs root&gt;/raspberry/123456789   /       nfs     defaults,rw,nolock   0  0</span><br><span class="line">tmpfs   /tmp    tmpfs   defaults    0   0</span><br><span class="line">tmpfs   /var/tmp    tmpfs   defaults    0   0</span><br><span class="line">tmpfs   /var/run    tmpfs   defaults    0   0</span><br></pre></td></tr></table></figure>

<p>Here we’ll mount some of the tmp dirs to tmpfs (mem fs).</p>
<p>The root fs is technically not required as in <code>cmdline.txt</code> the kernel already mounts it as <code>rw</code> but here we are explicitly marking it so and turning off disk check.</p>
<h3 id="Enable-NFS-Server"><a href="#Enable-NFS-Server" class="headerlink" title="Enable NFS Server"></a>Enable NFS Server</h3><p>For Synology this part is easy, in file sharing there’s an option to turn on NFS in File Services.</p>
<p><strong>Remember to turn off NFS squash in shared file</strong></p>
<img src="/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/nfs-permission.png">

<h2 id="Testing-and-Troubleshooting"><a href="#Testing-and-Troubleshooting" class="headerlink" title="Testing and Troubleshooting"></a>Testing and Troubleshooting</h2><p>So far we have completed the necessary steps. It’s time to unplug the Pi, remove the microSD card and reboot.</p>
<p>The Pi should tell us it fails reading the card and will try PXE boot next.</p>
<p>On the first screen it should show what files it’s trying to read and if it’s stuck on some of them check the tftp logs to see if they are placed properly.</p>
<p>Next it will show the rainbow screen like this</p>
<img src="/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/rainbow.jpg">

<p>If you see this, that means Pi’s GPU has been properly initialized and next it would try to load the kernel.</p>
<p>If the screen is stuck in this step, go back to check if the kernel file is properly uncompressed and referred to in config.txt file.</p>
<p>This screen should last for a few seconds to tens of seconds depending on network speed. After that the Linux kernel executable should take it over to init other stuff and mount the NFS root.</p>
<p>initramfs would be loaded at this moment and if the version does not match you might get some random weird errors. If NFS is not mounted correctly, it would tell so.</p>
<p>With Ubuntu depending on your actual env, there may be a few other extra non critical errors we need to fix like cloud-init but typically they would not block the startup process.</p>
<p>Now we should be able to ssh into the system with the username <code>ubuntu</code>.</p>
<p>Congrats we have finished the netboot setup and this can be replicated to other Pis with the same process.</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/linux/">linux</a> <a class="tag tag--primary tag--small t-link" href="/tags/network/">network</a> <a class="tag tag--primary tag--small t-link" href="/tags/raspberry/">raspberry</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a
                        class="post-action-btn btn btn--disabled"
                        aria-hidden="true"
                    >
                        
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-1-DHCP-Setup/"
                    data-tooltip="PXE Boot Diskless Raspberry Pi 4 With Ubuntu, Ubiquiti and Synology (1): DHCP Setup"
                    aria-label="NEXT: PXE Boot Diskless Raspberry Pi 4 With Ubuntu, Ubiquiti and Synology (1): DHCP Setup"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Shawn Xu. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a
                        class="post-action-btn btn btn--disabled"
                        aria-hidden="true"
                    >
                        
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-1-DHCP-Setup/"
                    data-tooltip="PXE Boot Diskless Raspberry Pi 4 With Ubuntu, Ubiquiti and Synology (1): DHCP Setup"
                    aria-label="NEXT: PXE Boot Diskless Raspberry Pi 4 With Ubuntu, Ubiquiti and Synology (1): DHCP Setup"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/"
                        aria-label="Share on Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/"
                        aria-label="Share on Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/"
                        aria-label="global.share_on_linkedin"
                    >
                        <i class="fab fa-linkedin" aria-hidden="true"></i><span>global.share_on_linkedin</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="https://miro.medium.com/fit/c/90/90/1*7cPXDgvy2_tKMHR4SEd-yQ.jpeg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Shawn Xu</h4>
        
            <div id="about-card-bio"><p>Software Engineer in Bay Area</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-a5wszscostah6olx2wgfq7mglfmluysmmlvnxgmmszk3gwouxhlbwbsk0xkf.min.js"></script>
<!--SCRIPTS END-->


    
        <script>
          var disqus_config = function() {
            this.page.url = 'https://xunnanxu.github.io/2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/';
              
            this.page.identifier = '2020/11/28/PXE-Boot-Diskless-Raspberry-Pi-4-With-Ubuntu-Ubiquiti-and-Synology-2-Config-TFTP-and-NFS-mounts/';
              
          };
          (function() {
            var d = document, s = d.createElement('script');
            var disqus_shortname = 'xcorpion';
            s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
    




    </body>
</html>
