
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Shawn&#39;s Pitstop">
    <title>Monitor gRPC Microservices in Kubernetes with Amazon X-Ray - Shawn&#39;s Pitstop</title>
    <meta name="author" content="Shawn Xu">
    
    
    
        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss2.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Shawn Xu","sameAs":["https://github.com/xunnanxu"],"image":"https://miro.medium.com/fit/c/90/90/1*7cPXDgvy2_tKMHR4SEd-yQ.jpeg"},"articleBody":"Microservice architecture is typically useful to solve certain scaling problems where service decoupling/segregation is required to improve development velocity, make service more fault tolerant or handle performance hotspots.\nHowever, everything comes with a price and so does microservice. One typical issue is:\n\n\nWhile this is half joking, monitoring and fault resilency are definitely more challenging in microservice world. While there are frameworks like Hystrix and resilience4j to handle circuit breaking, rate limiting and stuff like that, this post focuses on the first thing: how the heck are my services talking to each other?\nAWS X-Ray can fill the gap here by offering service mapping and tracing and thus you can see something like\n\n\n\n\nCompared to generic service monitoring,X-Ray has some additional benefits around AWS ecosystem in thatit will auto expose your AWS resource write(yes only write unfortunately) call insights when you use AWS SDK.This applies to SQS, SNS and DynamoDB.\n\n\nBut first of all, you need to understand how X-Ray works:\n\nX-Ray requires application to forward insights to the daemon.In EC2, this means the daemon process alongside with your application.In Kubenetes, this means you’d need to install it as a daemonset so it would run with your node.\nWhen a request enters the first service (typically an API gateway),the service is responsible for creating the first segment and generate the trace ID(typically created by AWS X-Ray SDK).A segment represents the overall lifecycle of a request within one application,identified by segment ID.A trace ID identifies the overall roundtrip of a request across multiple applications.\nA service, when making requests to other services,should generate corresponding subsegments.A subsegment is used to identify activities within one application.This is not required for service mapping but nice to have for tracing purposes.\nA service, when accepting traffic from other services,should relay the trace ID and the previous segment ID (called parent ID in SDK).This is such that the service mapping can be generated.\n\nFor inter-service communication, gRPC is often used. Compared to JSON over REST, gRPC offers more flexibility around query design and better performance thanks to the efficiency of (de)serialization with protobuf and the usage of http2 multiplexing. The extra typing and backward compatibility from protobuf also help documentation and maintenance, improving the overall quality of service quorum.\nHowever, while X-Ray SDK offers J2EE servlet filter for general http servers, gRPC does not follow that. The canonical gRPC Java implementation uses netty and has no knowledge around that.\nThis means we’d have to write some custom code. Unfortunately the documentation around that is next to none. Luckily, gRPC has implicit support via io.grpc.ServerInterceptor and io.grpc.ClientInterceptor so it’s just a matter of how to wire pieces together.\nOverall there are 4 steps:\n\nSet up Kubernetes daemonset\nGrant permission to Kubernetes nodes so they can write metrics to X-Ray.\nWrite/use interceptors in code\nRoute metrics to X-Ray daemon\n\nLet’s do this step by step:\nSet up Kubernetes daemonsetThere’s an example offered by Amazon regarding how to install it: link\nGrant permission to Kubernetes nodesThis is a bit tricky depending how your kube cluster is set up.\nIf you use EKS/EC2, you need to grant X-Ray write permission byattaching the canned policy to your IAM role for the worker nodes.\n\n\nIf you host your kubenetes outside AWS ecosystem,well chances are you don’t need X-Ray but something generic like Istio’s sidecar approach.But if you do need it then you can create IAM users,attach the policy and use these users in your code.\nWrite/use interceptors in codeFirst, we need to make sure we use the same language between server and client.In typical HTTP this is the headers.In gRPC this is the metadata, keyed by Key.\n123456public class Keys &#123;    public static final Metadata.Key&lt;String&gt; TRACE_ID_HEADER = Metadata.Key.of(&quot;traceId&quot;, Metadata.ASCII_STRING_MARSHALLER);    public static final Metadata.Key&lt;String&gt; PARENT_ID_HEADER = Metadata.Key.of(&quot;parentId&quot;, Metadata.ASCII_STRING_MARSHALLER);&#125;\n\nNow, let’s implement client interceptor.\nFirst you need some X-Ray stuff in classpath(assuming Gradle is used for dependence managmement, should be similar for maven/ivy/sbt):\n123456dependencies &#123;  compile (    &quot;com.amazonaws:aws-xray-recorder-sdk-core&quot;,    &quot;com.amazonaws:aws-xray-recorder-sdk-aws-sdk&quot;,  )&#125;\n\nNote for demonstration purpose the verion is omitted here,for actual usage you should peg the latest version at the time.\nIf you want X-Ray to instrument your AWS resource calls, you also need:\n1compile(&quot;com.amazonaws:aws-xray-recorder-sdk-aws-sdk-instrumentor&quot;)\n\nNow the code:\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849public class XRayClientInterceptor implements ClientInterceptor &#123;    private final AWSXRayRecorder recorder = AWSXRayRecorderBuilder.defaultRecorder();    @Override    public &lt;ReqT, RespT&gt; ClientCall&lt;ReqT, RespT&gt; interceptCall(            MethodDescriptor&lt;ReqT, RespT&gt; method, CallOptions callOptions, Channel next) &#123;        final Segment segment = recorder.getCurrentSegmentOptional().orElseGet(() -&gt; &#123;            //noinspection CodeBlock2Expr            return recorder.beginSegment(method.getFullMethodName());        &#125;);        final String segmentId = segment.getId();        final String traceId = segment.getTraceId().toString();        ClientCall&lt;ReqT, RespT&gt; call = next.newCall(method, callOptions);        return new ForwardingClientCall.SimpleForwardingClientCall&lt;ReqT, RespT&gt;(call) &#123;            @Override            public void start(Listener&lt;RespT&gt; responseListener, Metadata headers) &#123;                Subsegment callSegment = recorder.beginSubsegment(method.getFullMethodName());                final Entity context = recorder.getTraceEntity();                headers.discardAll(Keys.PARENT_ID_HEADER);                headers.put(Keys.PARENT_ID_HEADER, segmentId);                headers.put(Keys.TRACE_ID_HEADER, traceId);                delegate().start(                        new ForwardingClientCallListener.SimpleForwardingClientCallListener&lt;RespT&gt;(responseListener) &#123;                            @Override                            public void onClose(io.grpc.Status status, Metadata trailers) &#123;                                if (status.getCause() != null) &#123;                                    callSegment.addException(status.getCause());                                &#125; else if (!status.isOk()) &#123;                                    callSegment.setError(true);                                &#125;                                try &#123;                                    super.onClose(status, trailers);                                &#125; finally &#123;                                    Entity originalContext = recorder.getTraceEntity();                                    recorder.setTraceEntity(context);                                    try &#123;                                        callSegment.close();                                    &#125; finally &#123;                                        recorder.setTraceEntity(originalContext);                                    &#125;                                &#125;                            &#125;                        &#125;,                        headers);            &#125;        &#125;;    &#125;&#125;\n\nThere’s quite a lot of code here but the key gotchas are:\n\nYou should always use an existing segment if one exists,which is what getCurrentSegmentOptional() is for.Fail to do so would result in the loss of previous segment.If in some other code the previous segment is still referenced,you will get missing context exceptions when trying to close it.\nAlways bear in mind that data streaming/async handling is baked in gRPC design.So never close the segment directly after starting forwarding the client call.Instead, implement ClientCallListener and let gRPC tell you whenit actually starts/finishes it.\nAWSXRayRecorder is thread safe so using one for all calls should be fine.However, all the segments are tracked via ThreadLocalSegmentContext by default.That is shared by all instances across the entire app by defaulteven if you have multiple AWSXRayRecorder instances.What that implies is you shouldalways remember the corresponding context for that segment/subsegment,especially when crossing threads. Failure to do so would result in weird errors.This is what getTraceEntity() and setTraceEntity() are for.\nThe put() calls would append if key with the same name already exists.So remember to clean it up first.The trace ID meta doesn’t need to be cleared becauseit’s supposed to be the same as mentioned.\n\nAfter that, wire it up when you build the client:\n1newBlockingStub(channel).withInterceptors(new XRayClientInterceptor());\n\nNext, let’s build the server side interceptor:\nThis has some extra flavors in that it assumes you use a spring basedgRPC server like the LogNet Springboot one.The GRpcGlobalInterceptor would tell the runner to inject the interceptor automagically.If that’s not the case, that’s fine,just replace the appName with some other logic,and wire up the interceptor using ServerInterceptors.intercept(serviceDefinition, interceptors).\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576@GRpcGlobalInterceptorpublic class XRayServerInterceptor implements ServerInterceptor &#123;    @Value(&quot;$&#123;spring.application.name&#125;&quot;)    private String appName;    @Override    public &lt;ReqT, RespT&gt; ServerCall.Listener&lt;ReqT&gt; interceptCall(ServerCall&lt;ReqT, RespT&gt; call, Metadata headers, ServerCallHandler&lt;ReqT, RespT&gt; next) &#123;        String traceId = headers.get(Keys.TRACE_ID_HEADER);        String parentId = headers.get(Keys.PARENT_ID_HEADER);        TraceID tId = new TraceID();        if (traceId != null) &#123;            tId = TraceID.fromString(traceId);        &#125;        Segment segment = recorder.beginSegment(appName, tId, parentId);        headers.discardAll(Keys.PARENT_ID_HEADER);        headers.discardAll(Keys.TRACE_ID_HEADER);        headers.put(Keys.PARENT_ID_HEADER, segment.getId());        headers.put(Keys.TRACE_ID_HEADER, tId.toString());        ServerCall.Listener&lt;ReqT&gt; listener = next.startCall(call, headers);        return new ForwardingListener&lt;&gt;(listener, call, recorder, recorder.getTraceEntity(), segment);    &#125;&#125;public class ForwardingListener&lt;T, R&gt;        extends ForwardingServerCallListener.SimpleForwardingServerCallListener&lt;T&gt; &#123;    private ServerCall&lt;T, R&gt; call;    private AWSXRayRecorder recorder;    private Entity entity;    private Segment segment;    public ForwardingListener(ServerCall.Listener&lt;T&gt; delegate,            ServerCall&lt;T, R&gt; call,            AWSXRayRecorder recorder,            Entity entity,            Segment segment    ) &#123;        super(delegate);        this.call = call;        this.recorder = recorder;        this.entity = entity;        this.segment = segment;    &#125;    @Override    public void onCancel() &#123;        recorder.setTraceEntity(entity);        if (call.isCancelled()) &#123;            return;        &#125;        segment.setFault(true);        try &#123;            super.onCancel();        &#125;        finally &#123;            segment.close();        &#125;    &#125;    @Override    public void onComplete() &#123;        recorder.setTraceEntity(entity);        try &#123;            super.onComplete();        &#125;        catch (Throwable e) &#123;            segment.setError(true);        &#125;        finally &#123;            segment.close();        &#125;    &#125;&#125;\n\nRoute metrics to X-Ray daemonLast but not least, we need to tell X-Ray SDK to forward them to our daemon:\n1234567spec:  containers:  ...    - name: ...      env:      - name: AWS_XRAY_DAEMON_ADDRESS         value: xray-daemon:2000\n\nThe value corresponds to your daemon name.\nAWS_XRAY_DAEMON_ADDRESS will be read by AWS SDK at runtime.\nDoneAnd that’s it. Just deploy the apps to kube cluster.Bear in mind that the service map is bound to time range.It won’t show up until you get traffic across your apps.And if you have traffic split like A/B testing or servicemigration, you’ll see how things evolve over time,which is pretty cool.\n","dateCreated":"2018-11-25T14:11:39-08:00","dateModified":"2025-09-01T15:26:51-07:00","datePublished":"2018-11-25T14:11:39-08:00","description":"Microservice architecture is typically useful to solve certain scaling problems where service decoupling/segregation is required to improve development velocity, make service more fault tolerant or handle performance hotspots.\nHowever, everything comes with a price and so does microservice. One typical issue is:\n\n\nWhile this is half joking, monitoring and fault resilency are definitely more challenging in microservice world. While there are frameworks like Hystrix and resilience4j to handle circuit breaking, rate limiting and stuff like that, this post focuses on the first thing: how the heck are my services talking to each other?\nAWS X-Ray can fill the gap here by offering service mapping and tracing and thus you can see something like\n\n\n\n\nCompared to generic service monitoring,X-Ray has some additional benefits around AWS ecosystem in thatit will auto expose your AWS resource write(yes only write unfortunately) call insights when you use AWS SDK.This applies to SQS, SNS and DynamoDB.","headline":"Monitor gRPC Microservices in Kubernetes with Amazon X-Ray","image":[null,"xray.png"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/"},"publisher":{"@type":"Organization","name":"Shawn Xu","sameAs":["https://github.com/xunnanxu"],"image":"https://miro.medium.com/fit/c/90/90/1*7cPXDgvy2_tKMHR4SEd-yQ.jpeg","logo":{"@type":"ImageObject","url":"https://miro.medium.com/fit/c/90/90/1*7cPXDgvy2_tKMHR4SEd-yQ.jpeg"}},"url":"https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/","keywords":"monitoring, grpc, microservice, kubernetes, aws, xray","thumbnailUrl":"xray.png"}</script>
    <meta name="description" content="Microservice architecture is typically useful to solve certain scaling problems where service decoupling&#x2F;segregation is required to improve development velocity, make service more fault tolerant or ha">
<meta property="og:type" content="blog">
<meta property="og:title" content="Monitor gRPC Microservices in Kubernetes with Amazon X-Ray">
<meta property="og:url" content="https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/index.html">
<meta property="og:site_name" content="Shawn&#39;s Pitstop">
<meta property="og:description" content="Microservice architecture is typically useful to solve certain scaling problems where service decoupling&#x2F;segregation is required to improve development velocity, make service more fault tolerant or ha">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/ms-failure.png">
<meta property="og:image" content="https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/xray.png">
<meta property="og:image" content="https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/tracing.png">
<meta property="og:image" content="https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/iam.png">
<meta property="article:published_time" content="2018-11-25T22:11:39.000Z">
<meta property="article:modified_time" content="2025-09-01T22:26:51.289Z">
<meta property="article:author" content="Shawn Xu">
<meta property="article:tag" content="monitoring">
<meta property="article:tag" content="grpc">
<meta property="article:tag" content="microservice">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="aws">
<meta property="article:tag" content="xray">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/ms-failure.png">
    
    
        
    
    
        <meta property="og:image" content="https://miro.medium.com/fit/c/90/90/1*7cPXDgvy2_tKMHR4SEd-yQ.jpeg"/>
    
    
    
        <meta property="og:image" content="https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/xray.png"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/xray.png"/>
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-yvywglw62lgxwz25dsjvepo05oagkygdd7st7xfdzhmmxwqoijtiy3ngabtp.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-83953865-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-83953865-1');
    </script>


    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/%20"
            aria-label=""
        >
            Shawn&#39;s Pitstop
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="https://miro.medium.com/fit/c/90/90/1*7cPXDgvy2_tKMHR4SEd-yQ.jpeg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="https://miro.medium.com/fit/c/90/90/1*7cPXDgvy2_tKMHR4SEd-yQ.jpeg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Shawn Xu</h4>
                
                    <h5 class="sidebar-profile-bio"><p>Software Engineer in Bay Area</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/xunnanxu"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-left
                    post-header-cover--partial"
             style="background-image:url('/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/xray.png');"
             data-behavior="4">
            
        </div>

            <div id="main" data-behavior="4"
                 class="hasCover
                        hasCoverMetaOut
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Monitor gRPC Microservices in Kubernetes with Amazon X-Ray
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2018-11-25T14:11:39-08:00">
	
		    Nov 25, 2018
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Operation/">Operation</a>, <a class="category-link" href="/categories/Operation/Architecture/">Architecture</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>Microservice architecture is typically useful to solve certain scaling problems where service decoupling/segregation is required to improve development velocity, make service more fault tolerant or handle performance hotspots.</p>
<p>However, everything comes with a price and so does microservice. One typical issue is:</p>
<img src="/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/ms-failure.png" style="width: 600px" />

<p>While this is half joking, monitoring and fault resilency are definitely more challenging in microservice world. While there are frameworks like Hystrix and resilience4j to handle circuit breaking, rate limiting and stuff like that, this post focuses on the first thing: how the heck are my services talking to each other?</p>
<p>AWS X-Ray can fill the gap here by offering service mapping and tracing and thus you can see something like</p>
<img src="/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/xray.png" class="">

<img src="/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/tracing.png" class="">

<p>Compared to generic service monitoring,<br>X-Ray has some additional benefits around AWS ecosystem in that<br>it will auto expose your AWS resource write<br>(yes only write unfortunately) call insights when you use AWS SDK.<br>This applies to SQS, SNS and DynamoDB.</p>
<span id="more"></span>

<p>But first of all, you need to understand how X-Ray works:</p>
<ul>
<li>X-Ray requires application to forward insights to the daemon.<br>In EC2, this means the daemon process alongside with your application.<br>In Kubenetes, this means you’d need to install it as a daemonset so it would run with your node.</li>
<li>When a request enters the first service (typically an API gateway),<br>the service is responsible for creating the first <code>segment</code> and generate the <code>trace ID</code><br>(typically created by AWS X-Ray SDK).<br>A <code>segment</code> represents the overall lifecycle of a request within <strong>one</strong> application,<br>identified by <code>segment ID</code>.<br>A <code>trace ID</code> identifies the overall roundtrip of a request across <strong>multiple</strong> applications.</li>
<li>A service, when making requests to other services,<br>should generate corresponding <code>subsegment</code>s.<br>A <code>subsegment</code> is used to identify activities within one application.<br>This is not required for service mapping but nice to have for tracing purposes.</li>
<li>A service, when accepting traffic from other services,<br>should relay the trace ID and the previous segment ID (called parent ID in SDK).<br>This is such that the service mapping can be generated.</li>
</ul>
<p>For inter-service communication, gRPC is often used. Compared to JSON over REST, gRPC offers more flexibility around query design and better performance thanks to the efficiency of (de)serialization with protobuf and the usage of http2 multiplexing. The extra typing and backward compatibility from protobuf also help documentation and maintenance, improving the overall quality of service quorum.</p>
<p>However, while X-Ray SDK offers J2EE servlet filter for general http servers, gRPC does not follow that. The canonical <a href="https://github.com/grpc/grpc-java">gRPC Java implementation</a> uses netty and has no knowledge around that.</p>
<p>This means we’d have to write some custom code. Unfortunately the documentation around that is <a href="https://grpc.io/docs/quickstart/java.html">next to none</a>. Luckily, gRPC has implicit support via <code>io.grpc.ServerInterceptor</code> and <code>io.grpc.ClientInterceptor</code> so it’s just a matter of how to wire pieces together.</p>
<p>Overall there are 4 steps:</p>
<ol>
<li>Set up Kubernetes daemonset</li>
<li>Grant permission to Kubernetes nodes so they can write metrics to X-Ray.</li>
<li>Write/use interceptors in code</li>
<li>Route metrics to X-Ray daemon</li>
</ol>
<p>Let’s do this step by step:</p>
<h4 id="Set-up-Kubernetes-daemonset"><a href="#Set-up-Kubernetes-daemonset" class="headerlink" title="Set up Kubernetes daemonset"></a>Set up Kubernetes daemonset</h4><p>There’s an example offered by Amazon regarding how to install it: <a href="https://github.com/aws-samples/aws-xray-kubernetes">link</a></p>
<h4 id="Grant-permission-to-Kubernetes-nodes"><a href="#Grant-permission-to-Kubernetes-nodes" class="headerlink" title="Grant permission to Kubernetes nodes"></a>Grant permission to Kubernetes nodes</h4><p>This is a bit tricky depending how your kube cluster is set up.</p>
<p>If you use EKS/EC2, you need to grant X-Ray write permission by<br>attaching the canned policy to your IAM role for the worker nodes.</p>
<img src="/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/iam.png" style="width: 400px" />

<p>If you host your kubenetes outside AWS ecosystem,<br>well chances are you don’t need X-Ray but something generic like Istio’s sidecar approach.<br>But if you do need it then you can create IAM users,<br>attach the policy and use these users in your code.</p>
<h4 id="Write-use-interceptors-in-code"><a href="#Write-use-interceptors-in-code" class="headerlink" title="Write/use interceptors in code"></a>Write/use interceptors in code</h4><p>First, we need to make sure we use the same language between server and client.<br>In typical HTTP this is the headers.<br>In gRPC this is the metadata, keyed by <code>Key</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Keys</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Metadata.Key&lt;String&gt; TRACE_ID_HEADER = Metadata.Key.of(<span class="string">&quot;traceId&quot;</span>, Metadata.ASCII_STRING_MARSHALLER);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Metadata.Key&lt;String&gt; PARENT_ID_HEADER = Metadata.Key.of(<span class="string">&quot;parentId&quot;</span>, Metadata.ASCII_STRING_MARSHALLER);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now, let’s implement client interceptor.</p>
<p>First you need some X-Ray stuff in classpath<br>(assuming Gradle is used for dependence managmement, should be similar for maven/ivy/sbt):</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">  compile (</span><br><span class="line">    <span class="string">&quot;com.amazonaws:aws-xray-recorder-sdk-core&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.amazonaws:aws-xray-recorder-sdk-aws-sdk&quot;</span>,</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note for demonstration purpose the verion is omitted here,<br>for actual usage you should peg the latest version at the time.</p>
<p>If you want X-Ray to instrument your AWS resource calls, you also need:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile(<span class="string">&quot;com.amazonaws:aws-xray-recorder-sdk-aws-sdk-instrumentor&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Now the code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XRayClientInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ClientInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AWSXRayRecorder</span> <span class="variable">recorder</span> <span class="operator">=</span> AWSXRayRecorderBuilder.defaultRecorder();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ReqT, RespT&gt; ClientCall&lt;ReqT, RespT&gt; <span class="title function_">interceptCall</span><span class="params">(</span></span><br><span class="line"><span class="params">            MethodDescriptor&lt;ReqT, RespT&gt; method, CallOptions callOptions, Channel next)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Segment</span> <span class="variable">segment</span> <span class="operator">=</span> recorder.getCurrentSegmentOptional().orElseGet(() -&gt; &#123;</span><br><span class="line">            <span class="comment">//noinspection CodeBlock2Expr</span></span><br><span class="line">            <span class="keyword">return</span> recorder.beginSegment(method.getFullMethodName());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">segmentId</span> <span class="operator">=</span> segment.getId();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">traceId</span> <span class="operator">=</span> segment.getTraceId().toString();</span><br><span class="line">        ClientCall&lt;ReqT, RespT&gt; call = next.newCall(method, callOptions);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ForwardingClientCall</span>.SimpleForwardingClientCall&lt;ReqT, RespT&gt;(call) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(Listener&lt;RespT&gt; responseListener, Metadata headers)</span> &#123;</span><br><span class="line">                <span class="type">Subsegment</span> <span class="variable">callSegment</span> <span class="operator">=</span> recorder.beginSubsegment(method.getFullMethodName());</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Entity</span> <span class="variable">context</span> <span class="operator">=</span> recorder.getTraceEntity();</span><br><span class="line">                headers.discardAll(Keys.PARENT_ID_HEADER);</span><br><span class="line">                headers.put(Keys.PARENT_ID_HEADER, segmentId);</span><br><span class="line">                headers.put(Keys.TRACE_ID_HEADER, traceId);</span><br><span class="line">                delegate().start(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">ForwardingClientCallListener</span>.SimpleForwardingClientCallListener&lt;RespT&gt;(responseListener) &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(io.grpc.Status status, Metadata trailers)</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (status.getCause() != <span class="literal">null</span>) &#123;</span><br><span class="line">                                    callSegment.addException(status.getCause());</span><br><span class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!status.isOk()) &#123;</span><br><span class="line">                                    callSegment.setError(<span class="literal">true</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    <span class="built_in">super</span>.onClose(status, trailers);</span><br><span class="line">                                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                                    <span class="type">Entity</span> <span class="variable">originalContext</span> <span class="operator">=</span> recorder.getTraceEntity();</span><br><span class="line">                                    recorder.setTraceEntity(context);</span><br><span class="line">                                    <span class="keyword">try</span> &#123;</span><br><span class="line">                                        callSegment.close();</span><br><span class="line">                                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                                        recorder.setTraceEntity(originalContext);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        headers);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There’s quite a lot of code here but the key gotchas are:</p>
<ul>
<li>You should always use an existing segment if one exists,<br>which is what <code>getCurrentSegmentOptional()</code> is for.<br>Fail to do so would result in the loss of previous segment.<br>If in some other code the previous segment is still referenced,<br>you will get missing context exceptions when trying to close it.</li>
<li>Always bear in mind that data streaming/async handling is baked in gRPC design.<br>So never close the segment directly after starting forwarding the client call.<br>Instead, implement <code>ClientCallListener</code> and let gRPC tell you when<br>it actually starts/finishes it.</li>
<li><code>AWSXRayRecorder</code> is thread safe so using one for all calls should be fine.<br>However, all the segments are tracked via <code>ThreadLocalSegmentContext</code> by default.<br>That is shared by <strong>all</strong> instances across the entire app by default<br>even if you have multiple <code>AWSXRayRecorder</code> instances.<br>What that implies is you should<br><strong>always remember the corresponding context for that segment/subsegment</strong>,<br>especially when crossing threads. Failure to do so would result in weird errors.<br>This is what <code>getTraceEntity()</code> and <code>setTraceEntity()</code> are for.</li>
<li>The <code>put()</code> calls would append if key with the same name already exists.<br>So remember to clean it up first.<br>The trace ID meta doesn’t need to be cleared because<br>it’s supposed to be the same as mentioned.</li>
</ul>
<p>After that, wire it up when you build the client:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newBlockingStub(channel).withInterceptors(<span class="keyword">new</span> <span class="title class_">XRayClientInterceptor</span>());</span><br></pre></td></tr></table></figure>

<p>Next, let’s build the server side interceptor:</p>
<p>This has some extra flavors in that it assumes you use a spring based<br>gRPC server like the <a href="https://github.com/LogNet/grpc-spring-boot-starter">LogNet Springboot</a> one.<br>The <code>GRpcGlobalInterceptor</code> would tell the runner to inject the interceptor automagically.<br>If that’s not the case, that’s fine,<br>just replace the <code>appName</code> with some other logic,<br>and wire up the interceptor using <code>ServerInterceptors.intercept(serviceDefinition, interceptors)</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GRpcGlobalInterceptor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XRayServerInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ServerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.application.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ReqT, RespT&gt; ServerCall.Listener&lt;ReqT&gt; <span class="title function_">interceptCall</span><span class="params">(ServerCall&lt;ReqT, RespT&gt; call, Metadata headers, ServerCallHandler&lt;ReqT, RespT&gt; next)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">traceId</span> <span class="operator">=</span> headers.get(Keys.TRACE_ID_HEADER);</span><br><span class="line">        <span class="type">String</span> <span class="variable">parentId</span> <span class="operator">=</span> headers.get(Keys.PARENT_ID_HEADER);</span><br><span class="line">        <span class="type">TraceID</span> <span class="variable">tId</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TraceID</span>();</span><br><span class="line">        <span class="keyword">if</span> (traceId != <span class="literal">null</span>) &#123;</span><br><span class="line">            tId = TraceID.fromString(traceId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Segment</span> <span class="variable">segment</span> <span class="operator">=</span> recorder.beginSegment(appName, tId, parentId);</span><br><span class="line">        headers.discardAll(Keys.PARENT_ID_HEADER);</span><br><span class="line">        headers.discardAll(Keys.TRACE_ID_HEADER);</span><br><span class="line">        headers.put(Keys.PARENT_ID_HEADER, segment.getId());</span><br><span class="line">        headers.put(Keys.TRACE_ID_HEADER, tId.toString());</span><br><span class="line">        ServerCall.Listener&lt;ReqT&gt; listener = next.startCall(call, headers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ForwardingListener</span>&lt;&gt;(listener, call, recorder, recorder.getTraceEntity(), segment);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForwardingListener</span>&lt;T, R&gt;</span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">ForwardingServerCallListener</span>.SimpleForwardingServerCallListener&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServerCall&lt;T, R&gt; call;</span><br><span class="line">    <span class="keyword">private</span> AWSXRayRecorder recorder;</span><br><span class="line">    <span class="keyword">private</span> Entity entity;</span><br><span class="line">    <span class="keyword">private</span> Segment segment;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ForwardingListener</span><span class="params">(ServerCall.Listener&lt;T&gt; delegate,</span></span><br><span class="line"><span class="params">            ServerCall&lt;T, R&gt; call,</span></span><br><span class="line"><span class="params">            AWSXRayRecorder recorder,</span></span><br><span class="line"><span class="params">            Entity entity,</span></span><br><span class="line"><span class="params">            Segment segment</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(delegate);</span><br><span class="line">        <span class="built_in">this</span>.call = call;</span><br><span class="line">        <span class="built_in">this</span>.recorder = recorder;</span><br><span class="line">        <span class="built_in">this</span>.entity = entity;</span><br><span class="line">        <span class="built_in">this</span>.segment = segment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCancel</span><span class="params">()</span> &#123;</span><br><span class="line">        recorder.setTraceEntity(entity);</span><br><span class="line">        <span class="keyword">if</span> (call.isCancelled()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        segment.setFault(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.onCancel();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            segment.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line">        recorder.setTraceEntity(entity);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.onComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            segment.setError(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            segment.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Route-metrics-to-X-Ray-daemon"><a href="#Route-metrics-to-X-Ray-daemon" class="headerlink" title="Route metrics to X-Ray daemon"></a>Route metrics to X-Ray daemon</h4><p>Last but not least, we need to tell X-Ray SDK to forward them to our daemon:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">...</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AWS_XRAY_DAEMON_ADDRESS</span> </span><br><span class="line">        <span class="attr">value:</span> <span class="string">xray-daemon:2000</span></span><br></pre></td></tr></table></figure>

<p>The value corresponds to your daemon name.</p>
<p><code>AWS_XRAY_DAEMON_ADDRESS</code> will be read by AWS SDK at runtime.</p>
<h4 id="Done"><a href="#Done" class="headerlink" title="Done"></a>Done</h4><p>And that’s it. Just deploy the apps to kube cluster.<br>Bear in mind that the service map is bound to time range.<br>It won’t show up until you get traffic across your apps.<br>And if you have traffic split like A/B testing or service<br>migration, you’ll see how things evolve over time,<br>which is pretty cool.</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/aws/" rel="tag">aws</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/grpc/" rel="tag">grpc</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/kubernetes/" rel="tag">kubernetes</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/microservice/" rel="tag">microservice</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/monitoring/" rel="tag">monitoring</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/xray/" rel="tag">xray</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/04/04/Make-Wireless-BackHaul-Great-Again-Disable-Orbi-2-4G-Backhaul/"
                    data-tooltip="Make Wireless BackHaul Great Again: Disable Orbi 2.4G Backhaul"
                    aria-label="PREVIOUS: Make Wireless BackHaul Great Again: Disable Orbi 2.4G Backhaul"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/05/14/Angular-4-Custom-Bootstrapping-Lazy-Bind-to-Designated-Container/"
                    data-tooltip="Angular 4+ Custom Bootstrapping: Lazy Bind to Designated Container"
                    aria-label="NEXT: Angular 4+ Custom Bootstrapping: Lazy Bind to Designated Container"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Shawn Xu. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/04/04/Make-Wireless-BackHaul-Great-Again-Disable-Orbi-2-4G-Backhaul/"
                    data-tooltip="Make Wireless BackHaul Great Again: Disable Orbi 2.4G Backhaul"
                    aria-label="PREVIOUS: Make Wireless BackHaul Great Again: Disable Orbi 2.4G Backhaul"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/05/14/Angular-4-Custom-Bootstrapping-Lazy-Bind-to-Designated-Container/"
                    data-tooltip="Angular 4+ Custom Bootstrapping: Lazy Bind to Designated Container"
                    aria-label="NEXT: Angular 4+ Custom Bootstrapping: Lazy Bind to Designated Container"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/"
                        aria-label="Share on Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/"
                        aria-label="Share on Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/"
                        aria-label="global.share_on_linkedin"
                    >
                        <i class="fab fa-linkedin" aria-hidden="true"></i><span>global.share_on_linkedin</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="https://miro.medium.com/fit/c/90/90/1*7cPXDgvy2_tKMHR4SEd-yQ.jpeg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Shawn Xu</h4>
        
            <div id="about-card-bio"><p>Software Engineer in Bay Area</p>
</div>
        
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-a5wszscostah6olx2wgfq7mglfmluysmmlvnxgmmszk3gwouxhlbwbsk0xkf.min.js"></script>

<!--SCRIPTS END-->


    
        <script>
          var disqus_config = function() {
            this.page.url = 'https://xunnanxu.github.io/2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/';
              
            this.page.identifier = '2018/11/25/Monitor-gRPC-Microservices-in-Kubernetes-with-Amazon-X-Ray/';
              
          };
          (function() {
            var d = document, s = d.createElement('script');
            var disqus_shortname = 'xcorpion';
            s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
    




    </body>
</html>
